---
title: "Creating Enrichment Maps with Results from ActivePathways"
author: "Jonathan Barenboim"
date: "`r Sys.Date()`"
output: 
  rmarkdown::html_vignette:
    toc: false
vignette: >
  %\VignetteIndexEntry{enrichmentMap}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---
```{r, echo=FALSE}
knitr::opts_chunk$set(warning=FALSE, 
                      message=FALSE, 
                      width=500)
```

# Introduction 

This tutorial will demonstrate how to create a pathway enrichment map using the results from `ActivePathways`. The results from the main ActivePathways vignette will be used. To follow along with this vignette, use any Cytoscape files written by `ActivePathways` or follow the main ActivePathways vignette, ensuring that the Cytoscape files are saved in an accessible location.

# Required Files

Recall that `ActivePathways` writes four files to be used in Cytoscape.
```{r}
files <- c(system.file('extdata', 'pathways.txt', package='ActivePathways'),
           system.file('extdata', 'subgroups.txt', package='ActivePathways'),
           system.file('extdata', 'pathways.gmt', package='ActivePathways'),
           system.file('extdata', 'legend.pdf', package ='ActivePathways'))
```
```{r, eval=FALSE}
# Not run. 
res <- ActivePathways(dat, gmt, cytoscape.file.dir='path/to/results/directory')
```
The files written are:

* `pathways.txt` contains the list of significant pathways and the associated p-values. Note that only terms with `p.val <= significant` are written, even if the option `return.all=TRUE` is specified.

* `subgroups.txt` contains a matrix indicating the columns of the original scores matrix which contributed signficant pathways. A 1 indicates that the pathway is significant if `ActivePathways` is run on the p-values in that column.

* `pathways.gmt` contains a shortened version of the supplied GMT file which consists of only the significant pathways. This file can accelerate process of creating the network using Cytoscape.

* `legend.pdf` a pdf file of a legend which can be used as reference to the generated Cytoscape network.

```{r}
cat(paste(readLines(files[1])[1:5], collapse='\n'))
cat(paste(readLines(files[2])[1:5], collapse='\n'))
cat(paste(readLines(files[3])[1], collapse='\n'))
```

# Creating the Enrichment Map.
Open Cytoscape and ensure the *EnrichmentMap* and *enchancedGraphics* apps are installed. Apps may be installed by clicking *Apps -> App Manager* in Cytoscape. When the apps are installed, open the Apps menu again and click Enrichment Map. In the window that opens, click the *Add Data Set from Files* button (The '+') in the top left, change the Analysis Type to Generic/gProfiler and upload the `pathways.txt` and `pathways.gmt` files.

![](CreateEnrichmentMapDialogue.jpg)

Click Build to create the network.

![](NetworkStep1.jpg)

**P.S.** To make network a little more visually appealing, the Edge Cutoff slider in the EnrichmentMap panel can be adjusted to reduce the number of edges, the scale in the Tool Panel (View > Show Tool Panel) can be used to resize nodes, and the layout can be changed in the Layout tab (yFilesLayouts can be installed in apps, Layout > yFilesLayouts).

# Colour the Nodes by Subgroup
To upload the `subgroups.txt` table, go to file > import > table > file and import the `subgroups.txt` file.

Click the style tab in the left panel and ensure the Image/Chart1 property is available.

![](PropertiesDropDown2.jpg)

Under the Image/Chart 1 property, set the column to 'instruct' and the mapping type to 'passthrough'.

![](StylePanel.jpg)

This setting colours the pathway nodes according to the columns (types of evidence) in which the pathway is found to be enriched when considering the initial p-value matrix only one column at a time. 

![](NetworkStep2.jpg)

For the sake of convenience, ActivePathways generates Legend.pdf which can be added to the enrichment map using an image editting tool.

![](legend.jpg)
